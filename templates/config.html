{% extends "base.html" %}

{% block content %}

    <div class="container">
        <h1>Node Configuration</h1>
        
        <div class="section">
            <h2>Network Settings</h2>
            <div class="form-group">
                <label for="natType">NAT Type:</label>
                <input type="text" id="natType" readonly>
            </div>
            <div class="form-group">
                <label for="publicAddress">Public UDP Address:</label>
                <input type="text" id="publicAddress" readonly>
            </div>
            <div class="form-group">
                <label for="localUdpPort">Local UDP Port:</label>
                <input type="number" id="localUdpPort" readonly>
            </div>
            <div class="form-group">
                <label for="localTcpPort">Local TCP Port:</label>
                <input type="number" id="localTcpPort" readonly>
            </div>
            <button onclick="refreshNetworkInfo()">Refresh Network Info</button>
        </div>
        
        <div class="section">
            <h2>Peer Management</h2>
            <h3>Known Peers</h3>
            <table id="peersTable">
                <thead>
                    <tr>
                        <th>Peer ID</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <button onclick="refreshPeers()">Refresh Peer List</button>
        </div>
        
        <div class="section">
            <h2>Manual Peer Addition</h2>
            <div class="form-group">
                <label for="peerId">Peer ID:</label>
                <input type="text" id="peerId" placeholder="Enter peer ID">
            </div>
            <div class="form-group">
                <label for="peerAddress">Peer Address (host:port):</label>
                <input type="text" id="peerAddress" placeholder="Enter peer address">
            </div>
            <button onclick="addPeer()">Add Peer</button>
            <div id="peerStatus" class="status" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>Tracker Configuration</h2>
            <table id="trackersTable">
                <thead>
                    <tr>
                        <th>Tracker URL</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="form-group">
                <label for="newTracker">Add New Tracker:</label>
                <input type="text" id="newTracker" placeholder="Enter tracker URL (http://host:port)">
            </div>
            <button onclick="addTracker()">Add Tracker</button>
            <div id="trackerStatus" class="status" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Load initial data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            refreshNetworkInfo();
            refreshPeers();
            loadTrackers();
        });

        function refreshNetworkInfo() {
            fetch('/network/info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('natType').value = data.nat_type || 'Unknown';
                    document.getElementById('publicAddress').value = 
                        data.public_udp_addr ? `${data.public_udp_addr[0]}:${data.public_udp_addr[1]}` : 'Not available';
                    document.getElementById('localUdpPort').value = data.local_udp_port || '';
                    document.getElementById('localTcpPort').value = data.local_tcp_port || '';
                })
                .catch(error => console.error('Error fetching network info:', error));
        }

        function refreshPeers() {
            fetch('/peers/stats')
                .then(response => response.json())
                .then(peerStats => {
                    fetch('/peers')
                        .then(response => response.json())
                        .then(peers => {
                            const tbody = document.querySelector('#peersTable tbody');
                            tbody.innerHTML = '';
                            
                            for (const [peerId, address] of Object.entries(peers)) {
                                const stats = peerStats[peerId] || {};
                                const lastSeen = stats.last_seen ? new Date(stats.last_seen * 1000).toLocaleString() : 'Never';
                                const row = document.createElement('tr');
                                
                                row.innerHTML = `
                                    <td>${peerId}</td>
                                    <td>${address}</td>
                                    <td>
                                        ${stats.success_count || 0} successes<br>
                                        ${stats.fail_count || 0} failures<br>
                                        Last seen: ${lastSeen}
                                    </td>
                                    <td>
                                        <button class="success" onclick="addFriend('${peerId}')">Add Friend</button>
                                        <button class="danger" onclick="blacklistPeer('${peerId}')">Blacklist</button>
                                    </td>
                                `;
                                
                                tbody.appendChild(row);
                            }
                        });
                })
                .catch(error => console.error('Error fetching peers:', error));
        }

        function loadTrackers() {
            fetch('/network/trackers')
                .then(response => response.json())
                .then(trackers => {
                    const tbody = document.querySelector('#trackersTable tbody');
                    tbody.innerHTML = '';
                    
                    trackers.forEach(tracker => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${tracker.url}</td>
                            <td>${tracker.status}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching trackers:', error));
        }

        function addPeer() {
            const peerId = document.getElementById('peerId').value.trim();
            const peerAddress = document.getElementById('peerAddress').value.trim();
            const statusDiv = document.getElementById('peerStatus');
            
            if (!peerId || !peerAddress) {
                showStatus(statusDiv, 'Please enter both Peer ID and Address', 'error');
                return;
            }
            
            fetch('/peers/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    node_id: peerId,
                    address: peerAddress
                })
            })
            .then(response => {
                if (response.ok) {
                    showStatus(statusDiv, 'Peer added successfully!', 'success');
                    refreshPeers();
                } else {
                    showStatus(statusDiv, 'Failed to add peer', 'error');
                }
            })
            .catch(error => {
                showStatus(statusDiv, 'Error adding peer: ' + error, 'error');
            });
        }

        function addFriend(peerId) {
            fetch('/peers/friends/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    peer_id: peerId
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Peer added to friends list!');
                    refreshPeers();
                } else {
                    alert('Failed to add friend');
                }
            })
            .catch(error => {
                alert('Error adding friend: ' + error);
            });
        }

        function blacklistPeer(peerId) {
            if (!confirm('Are you sure you want to blacklist this peer?')) return;
            
            fetch('/peers/blacklist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    peer_id: peerId
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Peer blacklisted!');
                    refreshPeers();
                } else {
                    alert('Failed to blacklist peer');
                }
            })
            .catch(error => {
                alert('Error blacklisting peer: ' + error);
            });
        }

        function addTracker() {
            const trackerUrl = document.getElementById('newTracker').value.trim();
            const statusDiv = document.getElementById('trackerStatus');
            
            if (!trackerUrl) {
                showStatus(statusDiv, 'Please enter a tracker URL', 'error');
                return;
            }
            
            fetch('/network/trackers/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tracker_url: trackerUrl
                })
            })
            .then(response => {
                if (response.ok) {
                    showStatus(statusDiv, 'Tracker added successfully!', 'success');
                    loadTrackers();
                } else {
                    showStatus(statusDiv, 'Failed to add tracker', 'error');
                }
            })
            .catch(error => {
                showStatus(statusDiv, 'Error adding tracker: ' + error, 'error');
            });
        }

        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
    </script>
{% endblock %}